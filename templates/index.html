<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Record Audio</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Record Audio</h1>
        <div id="tests">
            {% for i in range(5) %}
            <div class="test card mb-4" style="display: none;">
                <div class="card-body">
                    <p>Expected letter {{ i+1 }}: <span class="expectedLetter" style="font-size: 2em; font-weight: bold;">{{ expected_letters[i] }}</span></p>
                    <button class="btn btn-primary recordButton" data-index="{{ i }}">Record</button>
                    <button class="btn btn-secondary stopButton" data-index="{{ i }}" disabled>Stop</button>
                    <button class="btn btn-info playButton" data-index="{{ i }}" disabled>Play</button>
                    <audio class="audioPlayback mt-3 w-100" controls></audio>
                    <p class="transcription mt-2"></p>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="text-center">
            <button id="nextButton" class="btn btn-primary">Next</button>
            <button id="submitButton" class="btn btn-success" style="display: none;" disabled>Submit</button>
            <p id="totalScore" class="font-weight-bold mt-3"></p>
        </div>
        <div id="results" class="mt-5" style="display: none;">
            <h2 class="text-center">Results</h2>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Test #</th>
                        <th>Expected Letter</th>
                        <th>Spoken Letter</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody">
                </tbody>
            </table>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        let currentTest = 0;
        let mediaRecorders = [];
        let audioChunks = Array.from({ length: 5 }, () => []);
        let audioBlobs = [];

        document.addEventListener('DOMContentLoaded', () => {
            showTest(currentTest);
        });

        function showTest(index) {
            document.querySelectorAll('.test').forEach((test, i) => {
                test.style.display = i === index ? 'block' : 'none';
            });
            document.getElementById('nextButton').style.display = index < 4 ? 'inline-block' : 'none';
            document.getElementById('submitButton').style.display = index === 4 ? 'inline-block' : 'none';
        }

        document.getElementById('nextButton').onclick = () => {
            if (currentTest < 4) {
                currentTest++;
                showTest(currentTest);
            }
        };

        document.querySelectorAll('.recordButton').forEach((button, index) => {
            button.onclick = async () => {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorders[index] = new MediaRecorder(stream);
                mediaRecorders[index].start();

                mediaRecorders[index].ondataavailable = event => {
                    audioChunks[index].push(event.data);
                };

                mediaRecorders[index].onstop = () => {
                    audioBlobs[index] = new Blob(audioChunks[index], { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlobs[index]);
                    document.querySelectorAll('.audioPlayback')[index].src = audioUrl;

                    audioChunks[index] = [];
                    document.querySelectorAll('.playButton')[index].disabled = false;
                    checkAllRecorded();
                };

                button.disabled = true;
                document.querySelectorAll('.stopButton')[index].disabled = false;
            };
        });

        document.querySelectorAll('.stopButton').forEach((button, index) => {
            button.onclick = () => {
                mediaRecorders[index].stop();
                document.querySelectorAll('.recordButton')[index].disabled = false;
                button.disabled = true;
            };
        });

        document.querySelectorAll('.playButton').forEach((button, index) => {
            button.onclick = () => {
                document.querySelectorAll('.audioPlayback')[index].play();
            };
        });

        function checkAllRecorded() {
            const allRecorded = audioBlobs.length === 5 && audioBlobs.every(blob => blob);
            document.getElementById('submitButton').disabled = !allRecorded;
        }

        document.getElementById('submitButton').onclick = async () => {
            const formData = new FormData();
            document.querySelectorAll('.expectedLetter').forEach((span, index) => {
                formData.append('expected_letters[]', span.innerText);
                formData.append(`audio_data_${index}`, audioBlobs[index], `recording_${index}.wav`);
            });

            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            result.transcriptions.forEach((transcription, index) => {
                document.querySelectorAll('.transcription')[index].innerText = "Spoken letter: " + transcription;
            });
            document.getElementById('totalScore').innerText = "Total score: " + result.total_score;

            // Display results
            const resultsTableBody = document.getElementById('resultsTableBody');
            resultsTableBody.innerHTML = '';
            result.expected_letters.forEach((expected, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${expected}</td>
                    <td>${result.transcriptions[index]}</td>
                `;
                resultsTableBody.appendChild(row);
            });
            document.getElementById('results').style.display = 'block';
        };
    </script>
</body>
</html>